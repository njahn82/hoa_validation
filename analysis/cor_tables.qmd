---
title: "Correlation tests"
format: 
    gfm:
      echo: true
      message: false
      warning: false
      code-fold: true
---

## About  

The aim of this document is to determine the correlation between coefficients for several hybrid open access indicators between hoaddata, Web of Science and Scopus.

## Data preparation

```{r lood_data}
library(tidyverse)
library(corrr)
library(stats)
library(Hmisc)
library(here)
library(gt)


# Load data
jn_df <- readr::read_csv(here("data", "/jn_country_stats_all.csv")) |>
  filter(issn_l != "0027-8424") |>
  mutate(earliest_year = as.character(earliest_year))


# Calculate indicators by country and year
my_df_ind <- jn_df |> 
  select(-earliest_year) |> 
  group_by(country_code) |> 
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) 
```

Automate reporting

```{r automate_tables}
#' Create a correlation matrix with significance markers
#'
#' @param data A data frame containing the variables for correlation analysis
#' @param vars A character vector of variable names to include in the correlation matrix
#' @param group_name A string to be included in the title of the correlation matrix
#' @return A list with the correlation data frame and title
#' @importFrom dplyr select all_of
#' @importFrom Hmisc rcorr
#' @importFrom stringr str_to_title
create_correlation_table <- function(data, vars, group_name) {
  # Check if all variables exist in the data
  missing_vars <- setdiff(vars, names(data))
  if (length(missing_vars) > 0) {
    warning(paste("The following variables are not in the dataset:", 
                  paste(missing_vars, collapse = ", ")))
    vars <- intersect(vars, names(data))
  }
  
  # Select only the specified variables
  subset_data <- data %>% select(all_of(vars))
  
  # Calculate Spearman correlation
  corr_result <- rcorr(as.matrix(subset_data), type = "spearman")
  r <- corr_result$r
  p <- corr_result$P
  
  # Create a dataframe for the table
  corr_df <- as.data.frame(r)
  
  # Add significance markers
  for (i in 1:nrow(r)) {
    for (j in 1:ncol(r)) {
      if (!is.na(p[i, j])) {
        if (p[i, j] < 0.001) {
          corr_df[i, j] <- paste0(round(r[i, j], 2), "***")
        } else if (p[i, j] < 0.01) {
          corr_df[i, j] <- paste0(round(r[i, j], 2), "**")
        } else if (p[i, j] < 0.05) {
          corr_df[i, j] <- paste0(round(r[i, j], 2), "*")
        } else {
          corr_df[i, j] <- round(r[i, j], 2)
        }
      }
    }
  }
  
  # Set diagonal to "-"
  for (i in 1:nrow(corr_df)) {
    corr_df[i, i] <- "-"
  }
  
  # Create a nicer version of variable names for display
  nice_names <- gsub("_", " ", vars)
  nice_names <- stringr::str_to_title(nice_names)
  
  # Set row and column names
  rownames(corr_df) <- nice_names
  colnames(corr_df) <- nice_names
  
  return(list(df = corr_df, title = paste("Spearman Correlation Matrix -", group_name)))
}

#' Display correlation matrix using gt package with row names
#'
#' @param corr_list A list containing the correlation data frame and title
#' @return A gt table object
#' @importFrom gt gt tab_header tab_footnote cells_body everything tab_options fmt_number
create_gt_upper_triangle <- function(corr_list) {
  footnote_text <- c("* p < 0.05", "** p < 0.01", "*** p < 0.001")
  
  # Convert the correlation dataframe to include row names as a column
  corr_df <- corr_list$df
  corr_df <- rownames_to_column(corr_df, var = "Variable")
  
  # Create the gt table
  gt_table <- gt(corr_df) %>%
    # Add title as header
    tab_header(
      title = corr_list$title
    ) %>%
    # Set the Variable column as row labels
    tab_stubhead(label = "Variable") %>%
    # Add footnotes for significance levels
    tab_footnote(
      footnote = footnote_text[1],
      locations = cells_body(
        columns = everything(),
        rows = everything()
      )
    ) %>%
    tab_footnote(
      footnote = footnote_text[2],
      locations = cells_body(
        columns = everything(),
        rows = everything()
      )
    ) %>%
    tab_footnote(
      footnote = footnote_text[3],
      locations = cells_body(
        columns = everything(),
        rows = everything()
      )
    ) %>%
    # Add styling
    tab_options(
      heading.title.font.size = px(16),
      heading.subtitle.font.size = px(13),
      table.font.size = px(12),
      column_labels.font.weight = "bold",
      table.width = pct(100),
      column_labels.background.color = "#f8f8f8",
      row_group.background.color = "#f8f8f8"
    ) %>%
    # Format any numeric columns
    fmt_number(
      columns = where(is.numeric),
      decimals = 2
    )
  
  return(gt_table)
}
```


##  Results

### Article volume 2019-23

```{r}

cor_articles <- create_correlation_table(my_df_ind, vars = c("hoad_articles", "scp_first_author_articles", "wos_first_author_articles", 
            "scp_corresponding_author_articles", "wos_corresponding_author_articles"), "Article volume")
create_gt_upper_triangle(cor_articles)
```
