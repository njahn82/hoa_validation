---
title: "eda"
output: github_document
---

```{r, knitr_setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

```{r r_setup}
library(bigrquery)
library(tidyverse)
#' Connect to DB 
#' 
#' BigQuery HOAD (Crossref, OpenAlex and open friends)
bq_con <- dbConnect(
  bigrquery::bigquery(),
  project = "subugoe-collaborative",
  billing = "subugoe-collaborative"
)
```

## Web of Science

### Open access

```{sql add_oa_info, connection = bq_con, output.var = "wos_oa"}
WITH oa_raw AS (SELECT DISTINCT item_id, doi, issn_l, CASE WHEN online_year IS NULL THEN pubyear ELSE online_year END AS earliest_year, is_oa
FROM (
SELECT
  wos.item_id, 
  wos.doi, 
  wos.issn_l,
  wos.pubyear,
  CAST(REGEXP_EXTRACT(wos_pubdate_online, r'^[0-9]{4}') AS NUMERIC) AS online_year,
  CASE
    WHEN cc IS NOT NULL AND vor = 1 THEN TRUE
  ELSE
  FALSE
END
  AS is_oa
FROM
  `hoa-article.hoa_comparision.wos_matching_20240410` AS wos
LEFT JOIN
  `subugoe-collaborative.hoaddata.cc_md` AS cc
ON
  wos.doi = cc.doi ) )
SELECT COUNT(DISTINCT item_id) as wos_articles, issn_l, earliest_year, is_oa
FROM oa_raw
GROUP BY issn_l, earliest_year, is_oa
ORDER BY issn_l, earliest_year
```
By year

```{r}
wos_all <- wos_oa |>
  group_by(earliest_year) |>
  summarise(articles = sum(wos_articles))

wos_oa |>
  filter(is_oa == TRUE) |>
  group_by(earliest_year) |>
  summarise(oa = sum(wos_articles)) |>
  right_join(wos_all) |>
  mutate(prop = oa / articles)
```
