---
title: "Results"
output: github_document
---

```{r, knitr_setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

```{r r_setup}
library(bigrquery)
library(tidyverse)
library(hoaddata)
#' Connect to DB 
#' 
#' BigQuery HOAD (Crossref, OpenAlex and open friends)
bq_con <- dbConnect(
  bigrquery::bigquery(),
  billing = "subugoe-collaborative",
  project = "subugoe-collaborative"
)
```

## Research questions

Are open data sources suitable to measure transformative agreements? More specifically, do analyses based on {hoaddata} yield comparable results compared to WoS and Scopus? 

## Journal and article volume

- Hybrid Journal coverage
- Article coverage (unsing document types)
- classification of publisher (top 3, other)

### Journal level

- JCT Journal data: `hoaddata::jct_hybrid_jns` (excluding PNAS)
- Crossref: Journal-level data on article volume including OA: `hoaddata::jn_ind`
- Web of Science: `data-raw/wos_jct_items.csv`

Levels:

- All
- Active: Have published at least one article between 2019 - 2023
- Hybrid OA: Have published at least one OA article between 2019 - 2023

#### Overview

HOAD:

```{r hoad_journal_level_prep}
hoad_jns <- hoaddata::jct_hybrid_jns |>
  filter(issn_l != "0027-8424")

hoad_oa_excluded <- bq_table_download("subugoe-collaborative.hoaddata.cc_oa_prop") |>
  distinct(issn_l)

active_jns <- hoad_jns |>
 # filter(!issn_l %in% hoad_oa_excluded$issn_l) |>
  inner_join(hoaddata::jn_ind, by = "issn_l") |>
  filter(!cr_year %in% c("2017", "2018", "2024"))

active_jns_with_oa <- active_jns |> 
  filter(!is.na(cc)) 
```

- Number of hybrid journals: `r length(unique(hoad_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(active_jns_with_oa$issn_l))`

Web of Science:

```{r wos_journal_level_prep}
wos_jct_items_df <- readr::read_csv(here::here("data-raw", "wos_jct_items_df.csv"))

wos_hybrid_jns <- wos_jct_items_df |>
  # No PNAS
  filter(issn_l != "0027-8424") |>
  # No Full OA detected by OA prop
  filter(!issn_l %in% hoad_oa_excluded$issn_l)

wos_active_jns <- wos_hybrid_jns |>
  filter(pubyear %in% 2019:2023)

wos_active_jns_with_oa <- wos_active_jns |> 
  filter(oa_status == "hybrid") 

# wos core 
wos_active_core <- wos_active_jns |>
  filter(item_type %in% c("Article", "Review"))
```

- Number of hybrid journals: `r length(unique(wos_hybrid_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(wos_active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(wos_active_jns_with_oa$issn_l))`

Scopus

```{r}
scp_jct_items_df <- readr::read_csv(here::here("data-raw", "scp_jct_items_df.csv"))

scp_hybrid_jns <- scp_jct_items_df |>
  # No PNAS
  filter(issn_l != "0027-8424") |>
  # No Full OA detected by OA prop
  filter(!issn_l %in% hoad_oa_excluded$issn_l)

scp_active_jns <- scp_hybrid_jns |>
  filter(pubyear %in% 2019:2023) 

scp_active_jns_with_oa <- scp_active_jns |> 
  filter(grepl("hybrid", oa_status))

# core
scp_active_core <- scp_active_jns |>
   filter(grepl("^Article|^Review", item_type))

scp_active_core_oa <- scp_active_core |>
    filter(grepl("hybrid", oa_status))
```

- Number of hybrid journals: `r length(unique(scp_hybrid_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(scp_active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(scp_active_jns_with_oa$issn_l))`

Core

- Active Journals: `r length(unique(scp_active_core$issn_l))`
- Active journals with OA: `r length(unique(scp_active_core_oa$issn_l))`

Journals without Original Articles and Reviews (mostly Proceedings)

```{r}
scp_active_jns |> 
  filter(!issn_l %in% scp_active_core$issn_l) |> 
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```

### Journal analytics

Journals with items published between 2019 - 2023

```{r upset_jns}
library(UpSetR)

jn_list <- list(
  crossref = unique(active_jns$issn_l),
  wos = unique(wos_active_jns$issn_l),
  scp = unique(scp_active_jns$issn_l)
)

# Plot Journals Five Years Period
upset(fromList(jn_list), order.by = "freq")

```

Print out journals, which are not in Crossref, but in WoS or Scopus

WoS:

```{r}
wos_active_jns |>
  filter(issn_l %in% setdiff(jn_list$wos, jn_list$crossref)) |>
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```
(Chinese Physics B seems to have the Chinese Physics ISSN-L in WOS)

Scopus:

```{r}
scp_active_jns |>
  filter(issn_l %in% setdiff(jn_list$scp, jn_list$crossref)) |>
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```

- `0094-243X` represents API Proceedings, all content tagged as proceedings article in Crossref.
- `0893-7400` changed to `1547-1896` and is present in both datasets
- `0095-2338` changed to `1549-9596`

### Item level view

```{r}
cr_df <- readr::read_csv(here::here("data-raw/hoad_dois_all_19_23.csv"))


item_view_df <-  list(
  crossref = unique(cr_df$doi),
  wos = unique(unlist(wos_active_core[!is.na(wos_active_core$doi),"doi"])),
  scp = unique(unlist(scp_active_core[!is.na(scp_active_core$doi),"doi"]))
)

# Plot Journals Five Years Period
upset(fromList(item_view_df), order.by = "freq")
```

### OA View

Journals with at least one OA item according to database

```{r}
jn_list_with_oa <- list(
  crossref = unique(active_jns_with_oa$issn_l),
  wos = unique(wos_active_core$issn_l),
  scp = unique(scp_active_core$issn_l)
)

upset(fromList(jn_list_with_oa), order.by = "freq")
```
### Item level

