---
title: "Journal and article coverage"
output: github_document
---

```{r, knitr_setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "99%",
  fig.align = "center",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

```{r r_setup}
library(bigrquery)
library(tidyverse)
library(hoaddata)
library(patchwork)
library(ComplexUpset)

#' Connect to DB 
#' 
#' BigQuery HOAD (Crossref, OpenAlex and open friends)
bq_con <- dbConnect(
  bigrquery::bigquery(),
  billing = "subugoe-collaborative",
  project = "subugoe-collaborative"
)

# Set themes for plots
my_base_size = 10

my_upset_theme <-
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title.position="plot",
        plot.title = element_text(hjust = 0, vjust = 1, face = "bold"))

```

## Research questions

Are open data sources suitable to measure transformative agreements? More specifically, do analyses based on {hoaddata} yield comparable results compared to WoS and Scopus? 

## Journal and article volume


- JCT Journal data: `hoaddata::jct_hybrid_jns` (excluding PNAS)
- Crossref: Journal-level data on article volume including OA: `hoaddata::jn_ind`
- Web of Science: `data-raw/wos_jct_items.csv`
- Scopus: `data-raw/scp_jct_items.csv`

Levels:

- All
- Active: Have published at least one article between 2019 - 2023
- Hybrid OA: Have published at least one OA article between 2019 - 2023

### Create analytical datasets

#### {hoaddata}

```{r hoad_journal_level_prep}
hoad_jns <- hoaddata::jct_hybrid_jns |>
  filter(issn_l != "0027-8424")

# Full OA journals detected through OA proportion > .95
hoad_oa_excluded <- bq_table_download("hoa-article.hoaddata_sep24.cc_oa_prop") |>
  distinct(issn_l)

active_jns <- hoad_jns |>
  # Only active hybrid journals from JCT
  inner_join(hoaddata::jn_ind, by = "issn_l") |>
  filter(!cr_year %in% c("2017", "2018", "2024"))

active_jns_with_oa <- active_jns |> 
  filter(!is.na(cc)) 
```

- Number of hybrid journals: `r length(unique(hoad_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(active_jns_with_oa$issn_l))`

#### Web of Science

```{r wos_journal_level_prep}
wos_jct_items_df <- readr::read_csv(here::here("data-raw", "wos_jct_items_df.csv"))

wos_hybrid_jns <- wos_jct_items_df |>
  # No PNAS
  filter(issn_l != "0027-8424") |>
  # No Full OA detected by OA prop
  filter(!issn_l %in% hoad_oa_excluded$issn_l)

wos_active_jns <- wos_hybrid_jns |>
  # Use online first, if available
  mutate(online_year = lubridate::year(wos_pubdate_online)) |>
  mutate(pub_year = ifelse(!is.na(online_year), online_year, pubyear)) |>
  filter(pub_year %in% 2019:2023)

wos_active_jns_with_oa <- wos_active_jns |> 
  filter(grepl("hybrid", oa_status))

# wos core 
wos_active_core <- wos_active_jns |>
  filter(grepl("Article|^Review$", item_type))

wos_active_core_oa <- wos_active_jns |>
   filter(grepl("hybrid", oa_status))
```

- Number of hybrid journals: `r length(unique(wos_hybrid_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(wos_active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(wos_active_jns_with_oa$issn_l))`

Core:

- Active Journals: `r length(unique(wos_active_core$issn_l))`
- Active journals with OA: `r length(unique(wos_active_core_oa$issn_l))`

#### Scopus

```{r}
scp_jct_items_df <- readr::read_csv(here::here("data-raw", "scp_jct_items_df.csv"))

scp_hybrid_jns <- scp_jct_items_df |>
  # No PNAS
  filter(issn_l != "0027-8424") |>
  # No Full OA detected by OA prop
  filter(!issn_l %in% hoad_oa_excluded$issn_l)

scp_active_jns <- scp_hybrid_jns |>
   # Use online first, if available
  mutate(pub_year = ifelse(!is.na(first_pubyear), first_pubyear, pubyear)) |>
  filter(pub_year %in% 2019:2023)

scp_active_jns_with_oa <- scp_active_jns |> 
  filter(grepl("hybrid", oa_status))

# core
scp_active_core <- scp_active_jns |>
   filter(grepl("^Article|^Review", item_type))

scp_active_core_oa <- scp_active_core |>
    filter(grepl("hybrid", oa_status))
```

- Number of hybrid journals: `r length(unique(scp_hybrid_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(scp_active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(scp_active_jns_with_oa$issn_l))`

Core

- Active Journals: `r length(unique(scp_active_core$issn_l))`
- Active journals with OA: `r length(unique(scp_active_core_oa$issn_l))`

Journals without Original Articles and Reviews (mostly Proceedings)

```{r}
scp_active_jns |> 
  filter(!issn_l %in% scp_active_core$issn_l) |> 
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```

## Coverage analysis: Journal and article volume

### Overview

Journals with items published between 2019 - 2023

```{r journal_coverage_dataset}
# DOI set too large to track it with Git, see 001_data_gathering how the data
# was obtained from Google BQ
cr_df <- readr::read_csv(here::here("data-raw/hoad_dois_all_19_23.csv"))

cr_active_upset <- cr_df |>
  filter(issn_l %in% active_jns$issn_l) |>
  group_by(issn_l) |>
  summarise(n_cr = n_distinct(doi)) |>
  mutate(Crossref = TRUE)
wos_active_upset <- wos_active_jns |>
  group_by(issn_l) |>
  summarise(n_wos = n_distinct(item_id)) |>
  mutate(WoS = TRUE)
scp_active_upset <- scp_active_jns |>
  group_by(issn_l) |>
  summarise(n_scp = n_distinct(item_id)) |>
  mutate(Scopus = TRUE)

jn_upset_ <- dplyr::full_join(cr_active_upset, wos_active_upset, by = "issn_l") |>
  dplyr::full_join(scp_active_upset, by = "issn_l") |>
  mutate(across(c(Crossref, WoS, Scopus), ~ replace_na(.x, FALSE))) |>
  # Journal 5-years article volume
  mutate(n = case_when(!is.na(n_cr) ~ n_cr, !is.na(n_scp) ~ n_scp, TRUE ~ n_wos))

## DOI overlap 

doi_overlap_df <- cr_df |>
  filter(issn_l %in% active_jns$issn_l) |>
  mutate(in_wos_and_scopus = ifelse(doi %in% wos_active_jns$doi & doi %in% scp_active_jns$doi, 1, 0),
         in_scopus = ifelse(doi %in% scp_active_jns$doi, 1, 0),
         in_wos =  ifelse(doi %in% wos_active_jns$doi, 1, 0))
doi_overlap <- doi_overlap_df |>
  group_by(issn_l) |>
  summarise(
    doi_in_wos_and_scopus = sum(in_wos_and_scopus),
    doi_in_scopus = sum(in_scopus),
    doi_in_wos = sum(in_wos))

jn_upset_articles <- jn_upset_ |> 
  left_join(doi_overlap, by = "issn_l") 

# Backup
jn_upset_articles
write_csv(jn_upset_articles, here::here("data/jn_upset_articles.csv"))
```

```{r journal_article_overlap_upset, fig.asp=0.75}
# Helper function to make text labels the same size as axis labels as seen in
# <https://wjschne.github.io/posts/making-text-labels-the-same-size-as-axis-labels-in-ggplot2/>
# Todo: Learn how to invoke it
ggtext_size <- function(base_size, ratio = 0.8) {
  ratio * base_size / ggplot2::.pt
}

bar_width <- 0.7
size <- get_size_mode("exclusive_intersection")

upset_overview <- ComplexUpset::upset(
  jn_upset_articles,
  c("Crossref", "WoS", "Scopus"),
  # Only journals in Crossref
  min_size = 30,
  set_sizes = FALSE,
  stripes = "transparent",
  # wrap = TRUE,
  name = "Data Source Coverage",
  base_annotations = list(
    "Journals" = (
      ComplexUpset::intersection_size(
        counts = TRUE,
        text = list(size = 8 / .pt),
        text_mapping = aes(
          label = paste0(!!upset_text_percentage(), '\n(', format(!!size, big.mark = ","), ')'),
          colour = ifelse(!!size > 5000, 'on_bar', 'on_background'),
          y = ifelse(!!size > 5000, !!size - 4000, !!size)
        ), width = bar_width
      ) +
        scale_y_continuous(labels = scales::number_format(big.mark = ",")) +
        ggtitle("A")
    )
  ),
  annotations = list(
    "Journal size\n(log scale)" = (
      ggplot(mapping = aes(x = intersection, y = n)) +
        geom_boxplot(outliers = FALSE, width = bar_width) +
        scale_y_log10(labels =  scales::number_format(big.mark = ",")) +
        ggtitle("C")
    ),
    "Articles" = (
      ggplot(mapping = aes(y = n_cr)) +
        geom_bar(
          stat = "identity",
          color = "grey80",
          width = bar_width,
          aes(fill = "in Crossref only")
        ) +
        geom_bar(
          aes(y = doi_in_wos_and_scopus, fill = "Shared"),
          stat = "identity",
          width = bar_width,
          color = "#0093c7"
        ) +
        geom_bar(
          aes(y = doi_in_wos, fill = "Shared"),
          stat = "identity",
          width = bar_width,
          color = "#0093c7"
        ) +
        geom_bar(
          aes(y = doi_in_scopus, fill = "Shared"),
          stat = "identity",
          width = bar_width,
          color = "#0093c7"
        ) +
        scale_fill_manual(
          values = c(
            `in Crossref only` = "grey80",
            `Shared` = "#0093c7"
          ),
          name = "DOI"
        ) +
        scale_y_continuous(labels =  scales::number_format(big.mark = ",")) +
        ggtitle("B")
    )
  ),
  matrix = (intersection_matrix(geom = geom_point(
    shape = "square", size = 2
  )))
)
upset_overview & my_upset_theme
```

The plot is limited to journals, which are indexed in Crossref. However, there
are `r jn_upset_articles |> filter(Crossref == FALSE) |> distinct(issn_l) |> nrow()` journals not incldued in Crossref, but in WoS or Scopus:

```{r}
jn_upset_articles |> 
  filter(Crossref == FALSE) |> 
  distinct(issn_l, n) |>
  arrange(desc(n)) |>
  janitor::adorn_totals()
```

WoS:

```{r}
jn_upset_articles |>
  filter(Crossref == FALSE, Scopus == FALSE, WoS == TRUE) |>
  distinct(issn_l, n) |>
  arrange(desc(n)) |>
  janitor::adorn_totals()
```
(Chinese Physics B seems to have the Chinese Physics ISSN-L in WOS)

Scopus:

```{r}
jn_upset_articles |>
  filter(Crossref == FALSE, Scopus == TRUE, WoS == FALSE) |>
  distinct(issn_l, n) |>
  arrange(desc(n)) |>
  janitor::adorn_totals()
```

- `0094-243X` represents API Proceedings, all content tagged as proceedings article in Crossref.
- `0893-7400` changed to `1547-1896` and is present in both datasets
- `0095-2338` changed to `1549-9596`
- `1542-5983` for `1542-5991` used in Scopus for different journal (Hearing Journal, 0745-7472). `1542-5983` journal changed to `2771-1897` since 2009

### By publisher

```{r upset_publisher_prepare_data}
# Add ESAC portfolio names
esac <- hoaddata::jct_hybrid_jns |>
  distinct(issn_l, esac_publisher) |>
  mutate(
    publisher = case_when(
      esac_publisher == "Elsevier" ~ "Elsevier",
      esac_publisher == "Springer Nature" ~ "Springer Nature",
      esac_publisher == "Wiley" ~ "Wiley",
      is.character(esac_publisher) ~ "Other"
    )) |>
  mutate(publisher =
           forcats::fct_relevel(
             publisher,
             c("Elsevier", "Springer Nature", "Wiley", "Other") 
           )) |>
  mutate(publisher = forcats::fct_rev(publisher)) |>
  distinct(issn_l, publisher)

jn_upset_publisher <- inner_join(jn_upset_articles, esac, by = "issn_l") |>
  # Because of Journal transfer, restrict choice to one portfolio
  distinct(issn_l, .keep_all = TRUE)
```

```{r upset_publisher_plot, fig.asp=0.75}
size = get_size_mode('exclusive_intersection')

upset_publisher_plot <- ComplexUpset::upset(
  jn_upset_publisher,
  c("Crossref", "WoS", "Scopus"),
  # Only journals in Crossref
  min_size = 30,
  width_ratio = 0.4,
  stripes = "transparent",
  name = "Data Source Coverage",
  base_annotations = NULL,
  annotations = list(
    "Journal size\n(log-scale)" = (
      ggplot(mapping = aes(x = intersection, y = n, fill = fct_rev(publisher))) +
        geom_boxplot(outliers = FALSE, width = bar_width) +
        scale_fill_manual(
          "",
          values = c(
            "Elsevier" = "#e9711c",
            "Springer Nature" = "#486a7e",
            "Wiley" = "#068853",
            "Other" = "#b3b3b3"
          ), guide = "none") +
        scale_y_log10(labels = scales::number_format(big.mark = ",")) +
        ggtitle("C")
    ),
    "Articles" = (
      ggplot(mapping = aes(y = n, fill = publisher, color = publisher)) +
        geom_bar(stat = "identity", width = bar_width) +
        scale_fill_manual(
          "",
          values = c(
            "Elsevier" = "#e9711c",
            "Springer Nature" = "#486a7e",
            "Wiley" = "#068853",
            "Other" = "#b3b3b3a0"
          ), guide = "none") +
        scale_color_manual(
          values = c(
            "Elsevier" = "#e9711c",
            "Springer Nature" = "#486a7e",
            "Wiley" = "#068853",
            "Other" = "#b3b3b3"
          ), guide = "none"
        ) + scale_y_continuous(labels = scales::number_format(big.mark = ",")) +
        ggtitle("B") 
    ),
    "Publisher" = (
      ggplot(mapping = aes(fill = publisher)) +
        geom_bar(stat = "count", position = "fill", width = bar_width) + 
        scale_y_continuous("Journals", labels = scales::percent_format()) +
        scale_fill_manual(
          "",
          values = c(
            "Elsevier" = "#e9711c",
            "Springer Nature" = "#486a7e",
            "Wiley" = "#068853",
            "Other" = "#b3b3b3"
          ), guide = "none") +
        ggtitle("A")
    )
  ),
  set_sizes = (
    upset_set_size(
      geom = geom_bar(aes(fill = publisher), width = 0.8), 
      position = "right"
    ) +
    scale_fill_manual(
      "",
      values = c(
        "Elsevier" = "#e9711c",
        "Springer Nature" = "#486a7e",
        "Wiley" = "#068853",
        "Other" = "#b3b3b3"
      )
    ) +
    scale_y_continuous(labels = scales::number_format(big.mark = ",")) +
    guides(fill = guide_legend(reverse = TRUE)) +
    ylab("Journals")
  ),
  guides = "over",
  matrix = (
    intersection_matrix(
      geom = geom_point(
        shape = "square",
        size = 2
      )
    )
  )
)

upset_publisher_plot & my_upset_theme 
```


What is the age of the journals?

```{r journal_age}
jn_age <- jn_ind |> 
  mutate(cr_year = as.numeric(as.character(cr_year))) |> 
  filter(cr_year %in% 2019:2023) |>
  group_by(issn_l) |>
  summarise(min_year = min(cr_year),
            max_year = max(cr_year)) |>
  mutate(jn_age = max_year - min_year + 1) 
```

DOI coverage check

```{r doi_coverage_check, eval = FALSE}
jn_overlap <- jn_upset_articles |> 
  filter(Crossref == TRUE, WoS == TRUE, Scopus == TRUE)

miss_doi <- cr_df |>
  filter(issn_l %in% jn_overlap$issn_l) |> 
  filter(!doi %in% wos_active_core$doi)

# Check if it is in WOS (full)
wos_type_diff <- wos_jct_items_df |>
  filter(doi %in% miss_doi$doi) 

miss_doi |>
  filter(!doi %in% wos_type_diff$doi) |>
  sample_n(10)
```

10.1016/j.apmr.2022.08.623 -> research poster abstract
10.1016/s1530-891x(20)39611-7 -> research abstract
10.1007/s42835-023-01664-z -> publsihed 2024
10.1097/yic.0000000000000534 -> published 2024
10.1038/s41415-022-5051-7 -> others
10.1016/j.matpr.2020.03.412 -> proceedings paper
10.3233/jifs-219108 -> doi does not work
10.1136/vr.m1027 -> paper review vet record!
10.1002/jmv.29204 -> indexing date 2024, pubyear 2023 
10.1159/000516826 -> subject index

  ## Replication

Here, I want to check whether we find consistent results across the three databases relative to open access uptake in hybrid journals in general, and relative to open access through agreements in particular. A particular focus will be whether findings change substantially when counting first or corresponding authors

Working definition replication: In scientific research, a replication is commonly defined as a study that is conducted using the same or similar methods as the original investigation, in order to evaluate whether consistent results can be obtained [1]. https://pmc.ncbi.nlm.nih.gov/articles/PMC10019630/

```{r}
# Web of Science
wos_jn_by_year <- readr::read_csv(here::here("data", "wos_jn_by_year.csv")) 

wos_jn_ta_by_year <- readr::read_csv(here::here("data", "wos_jn_ta_by_year.csv"))

wos_ta_df <- wos_jn_by_year |>
  # only hybrid journals with at least one oa between 2018 - 2023
  filter(issn_l %in% wos_active_jns_with_oa$issn_l) |>
  left_join(wos_jn_ta_by_year, by = c("issn_l", "earliest_year", "pub_type" = "pubtype")) |>
  # Focus on core
  filter(pub_type == "core") |>
  mutate(src = "Web of Science") |>
  select(-pub_type)

# Scopus
scp_jn_by_year <-  readr::read_csv(here::here("data", "scp_jn_by_year.csv")) 

scp_jn_ta_by_year <- readr::read_csv(here::here("data", "scp_ta_jn_by_year.csv"))

scp_ta_df <-  scp_jn_by_year |>
  # only hybrid journals with at least one oa between 2018 - 2023
  filter(issn_l %in% scp_active_jns_with_oa$issn_l) |>
  left_join(scp_jn_ta_by_year, by = c("issn_l", "earliest_year", "pub_type" = "pubtype")) |>
  # Focus on core
  filter(pub_type == "core") |>
  mutate(src = "Scopus") |>
  select(-pub_type)

# HOAD
hoad_jn_by_year_ <- active_jns_with_oa |>
  mutate(cr_year = as.numeric(as.character(cr_year))) |>
  distinct(issn_l, cr_year, n = jn_all)
hoad_oa_jn_by_year <- hoaddata::cc_articles |>
  group_by(issn_l, cr_year) |>
  summarise(oa_articles = n_distinct(doi))

hoad_jn_by_year <- inner_join(hoad_jn_by_year_, hoad_oa_jn_by_year, by = c("issn_l", "cr_year"))

hoad_jn_ta_by_year <- readr::read_csv(here::here("data-raw", "ta_oa_inst.csv"))

hoad_ta_by_year <- hoad_jn_ta_by_year |>
  filter(issn_l %in% active_jns_with_oa$issn_l, ta_active == TRUE) |>
  group_by(issn_l, cr_year) |>
  summarise(ta_first_author_articles = n_distinct(doi))

hoad_ta_oa_by_year <- hoad_jn_ta_by_year |>
  filter(issn_l %in% active_jns_with_oa$issn_l, ta_active == TRUE, !is.na(cc)) |>
  group_by(issn_l, cr_year) |>
  summarise(ta_oa_first_author_articles = n_distinct(doi))

hoad_jn_ta_by_year_ <- left_join(hoad_ta_by_year, hoad_ta_oa_by_year)

hoad_ta_df <- hoad_jn_by_year |>
  left_join(hoad_jn_ta_by_year_) |>
  # https://stackoverflow.com/a/73621978
  {\(.) {replace(.,is.na(.),0)}}() |>
  mutate(src = "HOAD") |>
  distinct(issn_l, earliest_year = cr_year, n, oa_articles, ta_articles = ta_first_author_articles, ta_first_author_articles, ta_oa_articles = ta_oa_first_author_articles, ta_oa_first_author_articles, src) 

uptake_df <- bind_rows(wos_ta_df, scp_ta_df, hoad_ta_df) |>
  mutate_if(is.numeric, ~replace(., is.na(.), 0))
```

```{r plot_uptake, fig.width=8}
# Data prep
uptake_by_year <- uptake_df |>
  mutate(earliest_year = as.character(earliest_year)) |>
  group_by(earliest_year, src) |>
  summarize(
    n_articles = sum(n),
    n_oa_articles = sum(oa_articles),
    ta_oa_first_author_articles = sum(ta_oa_first_author_articles),
    ta_oa_corresponding_author_articles = sum(ta_oa_corresponding_author_articles)
  )

uptake_by_year_df <- uptake_by_year |>
  # Remove HOAD because we only have first author data available
  filter(src != "HOAD", earliest_year != "2018") |>
  pivot_longer(cols = c(ta_oa_first_author_articles, ta_oa_corresponding_author_articles))

hoad_panel <- uptake_by_year |>
  filter(src == "HOAD") |>
  ggplot(aes(x = earliest_year)) +
  geom_bar(
    aes(y = n_oa_articles / n_articles, fill = "All"),
    stat = "identity",
    color = "#000000"
  ) +
  geom_bar(
    aes(y = ta_oa_first_author_articles / n_articles, fill = "TA OA"),
    stat = "identity",
    color = "#000000"
  ) +
  geom_text(
    aes(
      label = paste0(
        round(ta_oa_first_author_articles / n_oa_articles * 100, 1),
        "%\n(",
        format(ta_oa_first_author_articles, big.mark = ","),
        ")"
      ),
      y = ta_oa_first_author_articles / n_articles),
    position = position_dodge(width = 1),
    vjust = -0.2,
    # https://wjschne.github.io/posts/making-text-labels-the-same-size-as-axis-labels-in-ggplot2/
    size = 0.8 * my_base_size / .pt
  ) +
  scale_fill_manual(
    values = c("#b3b3b3a0", "#56B4E9"),
    name = "",
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::percent_format(),
    limits = c(0, .20),
    breaks = c(0, .05, .1, .15, .20)
  ) +
  theme_minimal(base_size = my_base_size) +
  labs(y = "Hybrid OA Uptake", x = NULL) +
  theme(
    legend.position = "top",
    legend.justification = "left"
  )

# Prepare facet labels
my_facet_labels <- c(ta_oa_first_author_articles = "First Author",
                  ta_oa_corresponding_author_articles = "Corresponding Author",
                  `Web of Science` = "Web of Science",
                  `Scopus` = "Scopus"
                )

wos_scp_uptake_panel <- uptake_by_year_df |>
  distinct(earliest_year, n_oa_articles, n_articles, src, name, value) |>
  # Modify factor levels to control order
  mutate(
    src = factor(src, levels = c("Web of Science", "Scopus")),
    name = factor(name, 
                 levels = c("ta_oa_first_author_articles", "ta_oa_corresponding_author_articles"))
  ) |>
  ggplot() +
  geom_bar(
    aes(
      x = earliest_year,
      y = n_oa_articles / n_articles,
      fill = "All"
    ),
    stat = "identity",
    color = "#000000"
  ) +
  geom_bar(
    aes(
      x = earliest_year,
      y = value / n_articles,
      fill = "TA OA"
    ),
    stat = "identity",
    color = "#000000"
  ) +
   geom_text(
    aes(
      label = paste0(
        round(value / n_oa_articles * 100, 1),
        "%\n(",
        format(value, big.mark = ","),
        ")"
      ),
      x = earliest_year,
      y = value / n_articles),
    position = position_dodge(width = 1),
    vjust = -0.2,
    # https://wjschne.github.io/posts/making-text-labels-the-same-size-as-axis-labels-in-ggplot2/
    size = 0.8 * my_base_size / .pt
  ) +
  facet_grid(src ~ name, labeller = as_labeller(my_facet_labels)) +
  scale_fill_manual(
    values = c("#b3b3b3a0", "#56B4E9"),
    name = "",
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::percent_format(),
    limits = c(0, .20),
    breaks = c(0, .05, .1, .15, .20)
  ) +
  theme_minimal(base_size = my_base_size) +
  labs(y = "Hybrid OA Uptake", x = NULL) +
  theme(
    legend.position = "top",
    legend.justification = "left")

## Combine to patchwork
layout <- "
AC
BB
"
wrap_plots(
  A = hoad_panel,
  B = wos_scp_uptake_panel,
  C = guide_area(),
  design = layout,
  guides = "collect",
  axes = "collect",
  heights = c(0.5, 1)
) &
  theme(
    legend.position = "top",
    legend.justification = "right",
    legend.direction = "horizontal",
 #   panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey50", fill = NA),
    axis.title=element_text(size = 10)) &
    plot_annotation(tag_levels = 'A')
```

### Scatterplot

```{r}
uptake_jn_five_jns <- uptake_df |>
  filter(earliest_year != "2018") |>
  group_by(issn_l, src) |>
  summarize(
    n_articles = sum(n),
    n_oa_articles = sum(oa_articles),
    ta_oa_first_author_articles = sum(ta_oa_first_author_articles),
    ta_oa_corresponding_author_articles = sum(ta_oa_corresponding_author_articles)
  )

uptake_scatter_df <- uptake_jn_five_jns |>
  pivot_longer(cols = c(ta_oa_first_author_articles, ta_oa_corresponding_author_articles)) |>
  select(issn_l, src, n_articles, n_oa_articles, author_position_oa = name, value) |>
  mutate(cat = tolower(paste(src, author_position_oa, sep = "_")))
```


```{r}
plot_uptake_jn_five_jns <- uptake_jn_five_jns |>
  mutate(oa_ta_first = ta_oa_first_author_articles,
         oa_ta_corr =  ta_oa_corresponding_author_articles) |> 
  distinct(issn_l, src, oa_ta_first, oa_ta_corr) |> 
  pivot_wider(names_from = src,
              values_from = c("oa_ta_first", "oa_ta_corr")) |> 
  janitor::clean_names() |>
  pivot_longer(
    cols = c(oa_ta_first_scopus, oa_ta_first_web_of_science, oa_ta_corr_scopus, oa_ta_corr_web_of_science)
  ) |>
  distinct(issn_l, oa_ta_first_hoad, name, value)
  
  
ggplot(plot_uptake_jn_five_jns, aes(oa_ta_first_hoad, value, group = name))  +
  geom_point(alpha = 0.05) +
  scale_x_log10() +
  scale_y_log10() +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray50") +
  coord_fixed() +
  facet_grid(~name)
```

### By publisher

```{r}
uptake_publisher <- uptake_df |>
  inner_join(esac, by = "issn_l") |>
  filter(earliest_year != "2018")

uptake_publisher_by_year <- uptake_publisher |>
  mutate(earliest_year = as.character(earliest_year)) |>
  group_by(earliest_year, src, publisher) |>
  summarize(
    n_articles = sum(n),
    n_oa_articles = sum(oa_articles),
    ta_oa_first_author_articles = sum(ta_oa_first_author_articles),
    ta_oa_corresponding_author_articles = sum(ta_oa_corresponding_author_articles)
  )

uptake_by_year_publisher_df <- uptake_publisher_by_year |>
  # Remove HOAD because we only have first author data available
  filter(src != "HOAD", earliest_year != "2018") |>
  pivot_longer(cols = c(ta_oa_first_author_articles, ta_oa_corresponding_author_articles))

hoad_publisher_panel <- uptake_publisher_by_year |>
  filter(src == "HOAD") |>
  ggplot(aes(x = earliest_year)) +
  geom_bar(
    aes(y = n_oa_articles / n_articles, fill = "All"),
    stat = "identity",
    color = "#000000"
  ) +
  geom_bar(
    aes(y = ta_oa_first_author_articles / n_articles, fill = "TA OA"),
    stat = "identity",
    color = "#000000"
  ) +
  geom_text(
    aes(
      label = paste0(
        round(ta_oa_first_author_articles / n_oa_articles * 100, 1),
        "%\n(",
        format(ta_oa_first_author_articles, big.mark = ","),
        ")"
      ),
      y = ta_oa_first_author_articles / n_articles),
    position = position_dodge(width = 1),
    vjust = -0.1,
    # https://wjschne.github.io/posts/making-text-labels-the-same-size-as-axis-labels-in-ggplot2/
    size = 0.8 * my_base_size / .pt
  ) + 
  facet_grid(~fct_rev(publisher)) +
  scale_fill_manual(
    values = c("#b3b3b3a0", "#56B4E9"),
    name = "",
    guide = guide_legend(reverse = TRUE)
  ) +
   scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::percent_format(),
    limits = c(0, .4),
    breaks = c(0, .1, .20, .3, .4)
  ) +
  theme_minimal(base_size = my_base_size) +
  labs(y = "Hybrid OA Uptake", x = NULL) +
  theme(
    legend.position = "top",
    legend.justification = "left"
  )

## label test


first_au_publisher_panel <- uptake_by_year_publisher_df |>
  distinct(earliest_year, publisher, n_oa_articles, n_articles, src, name, value) |>
  # Modify factor levels to control order
  mutate(
    src = factor(src, levels = c("Web of Science", "Scopus")),
    name = factor(name, 
                 levels = c("ta_oa_first_author_articles", "ta_oa_corresponding_author_articles"))
  ) |>
  filter(name == "ta_oa_first_author_articles") |>
  ggplot() +
   geom_bar(
    aes(
      x = earliest_year,
      y = n_oa_articles / n_articles,
      fill = "All"
    ),
    stat = "identity",
    color = "#000000a0",
    size = .2
  ) +
  geom_bar(
    aes(
      x = earliest_year,
      y = value / n_articles,
      fill = "TA OA"
    ),
    stat = "identity",
    color = "#000000a0",
    size = .2
  ) +
   geom_text(
    aes(
      label = paste0(
        round(value / n_oa_articles * 100, 1),
        "%\n(",
        format(value, big.mark = ","),
        ")"
      ),
      x = earliest_year,
      y = value / n_articles),
    position = position_dodge(width = 1),
    vjust = -0.2,
    # https://wjschne.github.io/posts/making-text-labels-the-same-size-as-axis-labels-in-ggplot2/
    size = 0.7 * my_base_size / .pt
  ) +
  facet_grid(src ~ fct_rev(publisher)) +
  scale_fill_manual(
    values = c("#b3b3b3a0", "#56B4E9"),
    name = "",
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::percent_format(),
    limits = c(0, .4),
    breaks = c(0, .1, .20, .3, .4)
  ) +
  theme_minimal(base_size = my_base_size) +
  labs(y = "Hybrid OA Uptake", x = NULL) +
  theme(
    legend.position = "top",
    legend.justification = "left")

cor_au_publisher_panel <- uptake_by_year_publisher_df |>
  distinct(earliest_year, publisher, n_oa_articles, n_articles, src, name, value) |>
  # Modify factor levels to control order
  mutate(
    src = factor(src, levels = c("Web of Science", "Scopus")),
    name = factor(name, 
                 levels = c("ta_oa_first_author_articles", "ta_oa_corresponding_author_articles"))
  ) |>
  filter(name == "ta_oa_corresponding_author_articles") |>
  ggplot() +
  geom_bar(
    aes(
      x = earliest_year,
      y = n_oa_articles / n_articles,
      fill = "All"
    ),
    stat = "identity",
    color = "#000000",
    size = .2
  ) +
  geom_bar(
    aes(
      x = earliest_year,
      y = value / n_articles,
      fill = "TA OA"
    ),
    stat = "identity",
    color = "#000000",
    size = .2
  ) +
   geom_text(
    aes(
      label = paste0(
        round(value / n_oa_articles * 100, 1),
        "%\n(",
        format(value, big.mark = ","),
        ")"
      ),
      x = earliest_year,
      y = n_oa_articles / n_articles),
    position = position_dodge(width = 1),
    vjust = -0.1,
    # https://wjschne.github.io/posts/making-text-labels-the-same-size-as-axis-labels-in-ggplot2/
    size = 0.8 * my_base_size / .pt
  ) +
  facet_grid(src ~ fct_rev(publisher)) +
  scale_fill_manual(
    values = c("#b3b3b3a0", "#56B4E9"),
    name = "",
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::percent_format(),
    limits = c(0, .4),
    breaks = c(0, .1, .20, .3, .4)
  ) +
  theme_minimal(base_size = my_base_size) +
  labs(y = "Hybrid OA Uptake", x = NULL) +
  theme(
    legend.position = "top",
    legend.justification = "left")
```

```{r, fig.asp=1, width = 12}
## Combine to patchwork
layout <- "
A
B
C
"
wrap_plots(
  A = hoad_publisher_panel,
  B = first_au_publisher_panel,
  C = cor_au_publisher_panel,
  D = guide_area(),
  design = layout,
  guides = "collect",
  axes = "collect",
  heights = c(1, 2, 2)
) &
  theme(
    legend.position = "top",
    legend.justification = "right",
    legend.direction = "horizontal",
 #   panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey50", fill = NA),
    axis.title=element_text(size = 10)) &
    plot_annotation(tag_levels = 'A')
```

- Elsevier gap suggests different oa information, let's make a scatterplot and contrast it hoad info using a shared corpus. due to publisher-specifc license 

ta by country

### shared

```{r}
# Create a shared corpus via DOI
wos_dois_active_jns_with_oa_core_df <- wos_active_jns |> 
  filter(issn_l %in% wos_active_core_oa$issn_l) |>
  filter(grepl("Article|^Review$", item_type)) |>
  mutate(is_hybrid_wos = grepl("hybrid", oa_status)) |>
  distinct(doi, is_hybrid_wos) |>
  mutate(wos = TRUE)

scp_dois_active_jns_with_oa_core_df <- scp_active_jns |> 
  filter(issn_l %in% scp_active_core_oa$issn_l) |>
  filter(grepl("^Article|^Review", item_type)) |>
  mutate(is_hybrid_scp = grepl("hybrid", oa_status)) |>
  distinct(doi, is_hybrid_scp) |>
  mutate(scopus = TRUE)

hoad_dois_active_jns_with_oa <- cr_df |> 
  filter(issn_l %in% active_jns_with_oa$issn_l, between(cr_year, 2019, 2023)) |>
  mutate(is_hybrid_hoad = doi %in% hoaddata::cc_articles$doi) |>
  distinct(doi, issn_l, is_hybrid_hoad) |>
  mutate(hoad = TRUE)

## Shared corpus
all_dois <- dplyr::full_join(hoad_dois_active_jns_with_oa, scp_dois_active_jns_with_oa_core_df, by = "doi") |>
  dplyr::full_join(wos_dois_active_jns_with_oa_core_df, by = "doi") |>
  mutate(across(where(is.logical), ~ replace_na(.x, FALSE))) |>
  filter(!is.na(doi))

shared_dois <- all_dois |>
  filter(wos == TRUE, scopus == TRUE, hoad == TRUE) 

## Merge Publisher info

shared_dois_df <- hoaddata::jct_hybrid_jns |>
  distinct(issn_l, esac_publisher) |>
  inner_join(shared_dois, by = "issn_l")
  
esac_five_years <- shared_dois_df |>
  group_by(esac_publisher) |>
  summarise(hoad = sum(hoad == TRUE),
            hoad_oa = sum(is_hybrid_hoad == TRUE),
            wos = sum(wos == TRUE),
            wos_oa = sum(is_hybrid_wos == TRUE),
            scp = sum(scopus == TRUE),
            scp_oa = sum(is_hybrid_scp == TRUE)) |>
  mutate(hoad_oa_prop = hoad_oa / hoad,
         wos_oa_prop = wos_oa / wos,
         scp_oa_prop = scp_oa / scp) |>
   mutate(
    publisher = case_when(
      esac_publisher == "Elsevier" ~ "Elsevier",
      esac_publisher == "Springer Nature" ~ "Springer Nature",
      esac_publisher == "Wiley" ~ "Wiley",
      is.character(esac_publisher) ~ "Other"
    )) |>
  mutate(publisher =
           forcats::fct_relevel(
             publisher,
             c("Elsevier", "Springer Nature", "Wiley", "Other") 
           )) 

oa_plot_df <- esac_five_years |> 
    pivot_longer(cols = contains(c("wos", "scp")))

oa_absolut_plot <- oa_plot_df |>
  filter(name %in% c("wos_oa", "scp_oa")) |>
  mutate(
    publisher = case_when(
      esac_publisher == "Elsevier" ~ "Elsevier",
      esac_publisher == "Springer Nature" ~ "Springer Nature",
      esac_publisher == "Wiley" ~ "Wiley",
      is.character(esac_publisher) ~ "Other"
    )
  ) |>
  mutate(publisher =
           forcats::fct_relevel(publisher, c(
             "Elsevier", "Springer Nature", "Wiley", "Other"
           ))) |>
  ggplot(aes(x = hoad_oa, y = value, size = hoad)) +
  geom_point(aes(fill = publisher), pch = 21) +
  scale_x_continuous(limits = c(0, max(
    c(
      esac_five_years$scp_oa,
      esac_five_years$hoad_oa,
      esac_five_years$wos_oa
    )
  )),
  labels = scales::number_format(big.mark = ",")) +
  scale_y_continuous(limits = c(0, max(
    c(
      esac_five_years$scp_oa,
      esac_five_years$hoad_oa,
      esac_five_years$wos_oa
    )
  )),
  labels = scales::number_format(big.mark = ",")) +
  scale_fill_manual(
    "",
    values = c(
      "Elsevier" = "#e9711c",
      "Springer Nature" = "#486a7e",
      "Wiley" = "#068853",
      "Other" = "#b3b3b3"
    )
  ) +
  facet_grid( ~ name) +
  geom_abline(slope = 1,
              intercept = 0,
              color = "blue") +
  coord_fixed() +
  theme_minimal(my_base_size)


oa_share_plot <- oa_plot_df |>
  filter(name %in% c("wos_oa", "scp_oa")) |>
   mutate(
    publisher = case_when(
      esac_publisher == "Elsevier" ~ "Elsevier",
      esac_publisher == "Springer Nature" ~ "Springer Nature",
      esac_publisher == "Wiley" ~ "Wiley",
      is.character(esac_publisher) ~ "Other"
    )) |>
  mutate(publisher =
           forcats::fct_relevel(
             publisher,
             c("Elsevier", "Springer Nature", "Wiley", "Other") 
           )) |>
  ggplot(aes(x = hoad_oa / hoad, y = value / hoad, size = hoad)) +
  geom_point(aes(fill = publisher),  pch = 21) +
  scale_x_continuous(limits = c(0, 1), labels = scales::percent_format()) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent_format())+
  scale_fill_manual(
      "",
      values = c(
        "Elsevier" = "#e9711c",
        "Springer Nature" = "#486a7e",
        "Wiley" = "#068853",
        "Other" = "#b3b3b3"
      )
    ) +
  facet_grid(~name) +
  geom_abline(slope = 1, intercept = 0, color = "blue") +
  coord_fixed() +
  theme_minimal(my_base_size)
```

```{r fig_oa_compare_scatter, fig.asp=1}
layout <- "
C
A
B
"
wrap_plots(
  A = oa_absolut_plot,
  B = oa_share_plot,
#  C = guide_area(),
  design = layout,
  guides = "collect",
  axes = "collect",
  heights = c(0.5, 1, 1)
) &
  theme(
   # legend.position = "top",
  #  legend.justification = "right",
 #   legend.direction = "horizontal",
 #   panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "grey50", fill = NA),
 #   axis.title=element_text(size = 10)
 ) &
    plot_annotation(tag_levels = 'A')
```


###

crossref / unpaywall

### TA countries

replication database vs database
validation shared corpus based on dois


