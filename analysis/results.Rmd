---
title: "Results"
output: github_document
---

```{r, knitr_setup, echo=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  dpi = 300
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(prettyNum(x, big.mark = ","))
    } else{
      return(x)
    }
  }
)
```

```{r r_setup}
library(bigrquery)
library(tidyverse)
library(hoaddata)
library(patchwork)

#' Connect to DB 
#' 
#' BigQuery HOAD (Crossref, OpenAlex and open friends)
bq_con <- dbConnect(
  bigrquery::bigquery(),
  billing = "subugoe-collaborative",
  project = "subugoe-collaborative"
)
```

## Research questions

Are open data sources suitable to measure transformative agreements? More specifically, do analyses based on {hoaddata} yield comparable results compared to WoS and Scopus? 

## Journal and article volume

- Hybrid Journal coverage
- Article coverage (unsing document types)
- classification of publisher (top 3, other)

### Journal level

- JCT Journal data: `hoaddata::jct_hybrid_jns` (excluding PNAS)
- Crossref: Journal-level data on article volume including OA: `hoaddata::jn_ind`
- Web of Science: `data-raw/wos_jct_items.csv`

Levels:

- All
- Active: Have published at least one article between 2019 - 2023
- Hybrid OA: Have published at least one OA article between 2019 - 2023

#### Overview

HOAD:

```{r hoad_journal_level_prep}
hoad_jns <- hoaddata::jct_hybrid_jns |>
  filter(issn_l != "0027-8424")

hoad_oa_excluded <- bq_table_download("subugoe-collaborative.hoaddata.cc_oa_prop") |>
  distinct(issn_l)

active_jns <- hoad_jns |>
 # filter(!issn_l %in% hoad_oa_excluded$issn_l) |>
  inner_join(hoaddata::jn_ind, by = "issn_l") |>
  filter(!cr_year %in% c("2017", "2018", "2024"))

active_jns_with_oa <- active_jns |> 
  filter(!is.na(cc)) 
```

- Number of hybrid journals: `r length(unique(hoad_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(active_jns_with_oa$issn_l))`

Web of Science:

```{r wos_journal_level_prep}
wos_jct_items_df <- readr::read_csv(here::here("data-raw", "wos_jct_items_df.csv"))

wos_hybrid_jns <- wos_jct_items_df |>
  # No PNAS
  filter(issn_l != "0027-8424") |>
  # No Full OA detected by OA prop
  filter(!issn_l %in% hoad_oa_excluded$issn_l)

wos_active_jns <- wos_hybrid_jns |>
  # use online first, if available
  mutate(online_year = lubridate::year(wos_pubdate_online)) |>
  mutate(pub_year = ifelse(!is.na(online_year), online_year, pubyear)) |>
  filter(pub_year %in% 2019:2023)

wos_active_jns_with_oa <- wos_active_jns |> 
  filter(oa_status == "hybrid") 

# wos core 
wos_active_core <- wos_active_jns |>
  filter(grepl("Article|^Review$", item_type))
```

- Number of hybrid journals: `r length(unique(wos_hybrid_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(wos_active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(wos_active_jns_with_oa$issn_l))`

Scopus

```{r}
scp_jct_items_df <- readr::read_csv(here::here("data-raw", "scp_jct_items_df.csv"))

scp_hybrid_jns <- scp_jct_items_df |>
  # No PNAS
  filter(issn_l != "0027-8424") |>
  # No Full OA detected by OA prop
  filter(!issn_l %in% hoad_oa_excluded$issn_l)

scp_active_jns <- scp_hybrid_jns |>
   # use online first, if available
  mutate(pub_year = ifelse(!is.na(first_pubyear), first_pubyear, pubyear)) |>
  filter(pub_year %in% 2019:2023)

scp_active_jns_with_oa <- scp_active_jns |> 
  filter(grepl("hybrid", oa_status))

# core
scp_active_core <- scp_active_jns |>
   filter(grepl("^Article|^Review", item_type))

scp_active_core_oa <- scp_active_core |>
    filter(grepl("hybrid", oa_status))
```

- Number of hybrid journals: `r length(unique(scp_hybrid_jns$issn_l))`
- Number of active hybrid journals between 2019 and 2023: `r length(unique(scp_active_jns$issn_l))`
- Number of active hybrid journals with at least one OA between 2019 and 2023: `r length(unique(scp_active_jns_with_oa$issn_l))`

Core

- Active Journals: `r length(unique(scp_active_core$issn_l))`
- Active journals with OA: `r length(unique(scp_active_core_oa$issn_l))`

Journals without Original Articles and Reviews (mostly Proceedings)

```{r}
scp_active_jns |> 
  filter(!issn_l %in% scp_active_core$issn_l) |> 
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```

### Journal analytics

Journals with items published between 2019 - 2023

```{r upset_jns}
library(UpSetR)

jn_list <- list(
  crossref = unique(active_jns$issn_l),
  wos = unique(wos_active_jns$issn_l),
  scp = unique(scp_active_jns$issn_l)
)

# Plot Journals Five Years Period
upset(fromList(jn_list), order.by = "freq")

```

Print out journals, which are not in Crossref, but in WoS or Scopus

WoS:

```{r}
wos_active_jns |>
  filter(issn_l %in% setdiff(jn_list$wos, jn_list$crossref)) |>
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```
(Chinese Physics B seems to have the Chinese Physics ISSN-L in WOS)

Scopus:

```{r}
scp_active_jns |>
  filter(issn_l %in% setdiff(jn_list$scp, jn_list$crossref)) |>
  group_by(issn_l) |>
  summarise(items = n_distinct(item_id)) |>
  arrange(desc(items)) |>
  janitor::adorn_totals()
```

- `0094-243X` represents API Proceedings, all content tagged as proceedings article in Crossref.
- `0893-7400` changed to `1547-1896` and is present in both datasets
- `0095-2338` changed to `1549-9596`

### Item level view

```{r}
cr_df <- readr::read_csv(here::here("data-raw/hoad_dois_all_19_23.csv"))


item_view_df <-  list(
  crossref = unique(cr_df$doi),
  wos = unique(unlist(wos_active_core[!is.na(wos_active_core$doi),"doi"])),
  scp = unique(unlist(scp_active_core[!is.na(scp_active_core$doi),"doi"]))
)

# Plot Journals Five Years Period
UpSetR::upset(UpSetR::fromList(item_view_df), order.by = "freq")
```

### OA View

Journals with at least one OA item according to database

```{r}
jn_list_with_oa <- list(
  crossref = unique(active_jns_with_oa$issn_l),
  wos = unique(wos_active_core$issn_l),
  scp = unique(scp_active_core$issn_l)
)

upset(fromList(jn_list_with_oa), order.by = "freq")
```

#### Compose a complex upset

```{r upset_data, fig.asp=0.8}
cr_active_upset <- cr_df |>
  filter(issn_l %in% active_jns$issn_l) |>
  group_by(issn_l) |>
  summarise(n_cr = n_distinct(doi)) |>
  mutate(Crossref = TRUE)
wos_active_upset <- wos_active_jns |>
  group_by(issn_l) |>
  summarise(n_wos = n_distinct(item_id)) |>
  mutate(WoS = TRUE)
scp_active_upset <- scp_active_jns |>
  group_by(issn_l) |>
  summarise(n_scp = n_distinct(item_id)) |>
  mutate(Scopus = TRUE)

jn_upset_ <- dplyr::full_join(cr_active_upset, wos_active_upset, by = "issn_l") |>
  dplyr::full_join(scp_active_upset, by = "issn_l") |>
  mutate(across(c(Crossref, WoS, Scopus), ~replace_na(.x, FALSE))) |>
  # Journal 5-years article volume
  mutate(n = case_when(!is.na(n_cr) ~ n_cr, !is.na(n_scp) ~n_scp, TRUE ~ n_wos))

# add year
jn_age <- jn_ind |> 
  mutate(cr_year = as.numeric(as.character(cr_year))) |> 
  filter(cr_year %in% 2019:2023) |>
  group_by(issn_l) |>
  summarise(min_year = min(cr_year),
            max_year = max(cr_year)) |>
  mutate(jn_age = max_year - min_year + 1) 

# Add Esac publisher

esac <- hoaddata::jct_hybrid_jns |>
  distinct(issn_l, esac_publisher) |>
  mutate(
    publisher = case_when(
      esac_publisher == "Elsevier" ~ "Elsevier",
      esac_publisher == "Springer Nature" ~ "Springer Nature",
      esac_publisher == "Wiley" ~ "Wiley",
      is.character(esac_publisher) ~ "Other"
    )) |>
  mutate(publisher =
           forcats::fct_relevel(
             publisher,
             c("Elsevier", "Springer Nature", "Wiley", "Other") 
           )) |>
  mutate(publisher = forcats::fct_rev(publisher)) |>
  distinct(issn_l, publisher)

library(ComplexUpset)
jn_upset <- inner_join(jn_upset_, esac, by = "issn_l") |>
  distinct(issn_l, .keep_all = TRUE)

size = get_size_mode('exclusive_intersection')

ComplexUpset::upset(
  jn_upset,
  c("Crossref", "WoS", "Scopus"),
  # Only journals in Crossref
  min_size = 30,
  width_ratio = 0.4,
  stripes = "transparent",
  name = "Data Source Coverage",
  base_annotations = list(
    "Journals" = (
      ComplexUpset::intersection_size(
        counts = TRUE,
        text = list(size = 9 / .pt),
        text_mapping = aes(
          label = paste0(!!upset_text_percentage(), '\n(', !!size, ')'),
          colour = ifelse(!!size > 5000, 'on_bar', 'on_background'),
          y = ifelse(!!size > 5000, !!size - 4000, !!size)
        )
      ) +
        scale_y_continuous(labels = scales::number_format(big.mark = ","))
    )
  ),
  annotations = list("Article Volume" = (
    ggplot(mapping = aes(x = intersection, y = n, fill = fct_rev(publisher))) +
      geom_boxplot(outliers = FALSE) +
              scale_fill_manual(
        "",
        values = c(
          "Elsevier" = "#e9711c",
          "Springer Nature" = "#486a7e",
          "Wiley" = "#068853",
          "Other" = "#b3b3b3a0"
        ), guide = "none") +
      scale_y_log10(labels =  scales::number_format(big.mark = ","))),
    "Publisher" = (
      ggplot(mapping = aes(fill = publisher)) +
        geom_bar(stat = "count", position ="fill") + 
        scale_y_continuous("Publisher Share", labels=scales::percent_format()) +
        scale_fill_manual(
        "",
        values = c(
          "Elsevier" = "#e9711c",
          "Springer Nature" = "#486a7e",
          "Wiley" = "#068853",
          "Other" = "#b3b3b3a0"
        ), guide = "none"))), 
  #,
  # 'Total article' = (
  #   ggplot(mapping = aes(x = intersection, y = n)) +
  #     geom_bar(stat = "identity", color = "grey35", fill = "grey35")) +
  #  scale_y_continuous(labels =  scales::number_format(big.mark = ",")) ),
  set_sizes=(
        upset_set_size(
          geom = geom_bar(aes(fill = publisher), width = 0.8), 
          position='right')) +
          scale_fill_manual("", values = c(
          "Elsevier" = "#e9711c",
          "Springer Nature" = "#486a7e",
          "Wiley" = "#068853",
          "Other" = "#b3b3b3a0")) +
    scale_y_continuous(labels = scales::number_format(big.mark = ",")) +
    guides(fill = guide_legend(reverse = TRUE)) +
    ylab("Journals"),
      guides = "over",
  matrix = (
        intersection_matrix(
            geom = geom_point(
                shape = "square",
                size=3.5
            )))
        ) +
  patchwork::plot_layout(heights=c(2, 1.5, 2, 1))
```

What is the age of the journals?

```{r journal_age}
jn_age <- jn_ind |> 
  mutate(cr_year = as.numeric(as.character(cr_year))) |> 
  filter(cr_year %in% 2019:2023) |>
  group_by(issn_l) |>
  summarise(min_year = min(cr_year),
            max_year = max(cr_year)) |>
  mutate(jn_age = max_year - min_year + 1) 
```

### DOI coverage

```{r doi_coverage_check}
jn_overlap <- jn_upset |> 
  filter(Crossref == TRUE, WoS == TRUE, Scopus == TRUE)

miss_doi <- cr_df |>
  filter(issn_l %in% jn_overlap$issn_l) |> 
  filter(!doi %in% wos_active_core$doi)

# Check if it is in WOS (full)
wos_type_diff <- wos_jct_items_df |>
  filter(doi %in% miss_doi$doi) 

miss_doi |>
  filter(!doi %in% wos_type_diff$doi) |>
  sample_n(10)
```

### Add Article Coverage

- hoaddata: Crossref exclunding paratext and proceedings as indicated by pattern macthing. Patterns mostly from Unpaywall / OpenAlex
- WoS: All DOIs / DOIS only article and reviews
- Scopus: All DOIs / DOIS only article and reviews

```{r fig.asp=0.8}
 doi_overlap_df <- cr_df |>
  filter(issn_l %in% active_jns$issn_l) |>
  mutate(in_wos_and_scopus = ifelse(doi %in% wos_active_jns$doi & doi %in% scp_active_jns$doi, 1, 0),
         in_scopus = ifelse(doi %in% scp_active_jns$doi, 1, 0),
         in_wos =  ifelse(doi %in% wos_active_jns$doi, 1, 0))
doi_overlap <- doi_overlap_df |>
  group_by(issn_l) |>
  summarise(
    doi_in_wos_and_scopus = sum(in_wos_and_scopus),
    doi_in_scopus = sum(in_scopus),
    doi_in_wos = sum(in_wos))

jn_upset_articles <- jn_upset |> 
  left_join(doi_overlap, by = "issn_l") 


### Plot
size = get_size_mode('exclusive_intersection')

upset_overview <- ComplexUpset::upset(
  jn_upset_articles,
  c("Crossref", "WoS", "Scopus"),
  # Only journals in Crossref
  min_size = 30,
  width_ratio = 0.4,
  set_sizes=FALSE,
  stripes = "transparent",
  wrap = TRUE,
  name = "Data Source Coverage",
  base_annotations = list(
    "Journals" = (
      ComplexUpset::intersection_size(
        counts = TRUE,
        text = list(size = 9 / .pt),
        text_mapping = aes(
          label = paste0(!!upset_text_percentage(), '\n(', !!size, ')'),
          colour = ifelse(!!size > 5000, 'on_bar', 'on_background'),
          y = ifelse(!!size > 5000, !!size - 4000, !!size)
        )
      ) +
        scale_y_continuous(labels = scales::number_format(big.mark = ","))
    )
  ),
  annotations = list("Journal size\n(log scale)" = (
    ggplot(mapping = aes(x = intersection, y = n)) +
      geom_boxplot(outliers = FALSE) +
      scale_y_log10(labels =  scales::number_format(big.mark = ","))),
    "Articles" = (ggplot(mapping = aes(y = n_cr)) +
                        geom_bar(stat = "identity", color = "grey80", aes(fill = "in Crossref only")) +
                        geom_bar(aes(y = doi_in_wos_and_scopus, fill = "Shared"), stat = "identity", color = "#0093c7") +
                        geom_bar(aes(y = doi_in_wos, fill = "Shared"), stat = "identity", color = "#0093c7") +
                        geom_bar(aes(y = doi_in_scopus, fill = "Shared"), stat = "identity", color = "#0093c7") +
                        scale_fill_manual(values = c(`in Crossref only` = "grey80", `Shared` = "#0093c7"), name = "") +
                        scale_y_continuous(labels =  scales::number_format(big.mark = ",")) +
                        theme(
    legend.position = "top",
    legend.justification = "right"
  ) +
    guides(fill = "none")
    )),
   matrix = (
        intersection_matrix(
            geom = geom_point(
                shape = "square",
                size = 2
            )))
        ) 
upset_overview
```

```{r dois_over_the_years}
doi_coverage_over_years <- doi_overlap_df |>
  group_by(cr_year) |>
  summarise(dois = n_distinct(doi),
            in_wos_and_scopus = sum(in_wos_and_scopus, na.rm = TRUE),
            in_scopus = sum(in_scopus, na.rm = TRUE),
            in_wos = sum(in_wos)) |>
  pivot_longer(cols = c(dois, in_wos_and_scopus, in_scopus, in_wos)) |>
  mutate(cr_year = gsub("^20", "'", as.character(cr_year)))

# dois all
dois_all_by_year <- doi_coverage_over_years |>
  filter(name == "dois") |>
  select(-name)

coverage_over_year_plot <- doi_coverage_over_years |>
  filter(name != "dois") |>
  # Fix order of panel
  mutate(name = factor(name, levels = c("in_wos_and_scopus", "in_scopus", "in_wos"))) |>
  ggplot(aes(x = cr_year, y = value)) +
  geom_bar(data = dois_all_by_year, aes(fill = "in Crossref only"), color = "transparent", stat = "identity") +
  geom_bar(aes(fill = "Shared"), color = "transparent", stat = "identity") +
  facet_wrap( ~ name, ncol = 1) +
  scale_fill_manual(values = c("grey80", "#0093c7"), name = "") +
  scale_y_continuous(labels =  scales::number_format(big.mark = ",")) +
  labs(x = "Year published", y = "Articles with DOI") + 
  theme_minimal() +
  theme(legend.position = "top",
        legend.justification = "right") 
coverage_over_year_plot
```

```{r coverage_upset_patch, fig.asp=0.85}
design = "AB"
wrap_plots(
  A = upset_overview,
  B = coverage_over_year_plot,
  design = design,
  widths = c(3.5,1)
) & plot_annotation(tag_levels = 'A') 
```

